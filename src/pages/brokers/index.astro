---
import BaseLayout from '@/layouts/BaseLayout.astro';
import Header from '@/components/layout/Header.astro';
import Footer from '@/components/layout/Footer.astro';
import { getCollection } from 'astro:content';

// Get all brokers
const allBrokers = await getCollection('brokers');

// Sort by trust score and rating
const brokers = allBrokers.sort((a, b) => {
  if (a.data.scamAlert !== b.data.scamAlert) {
    return a.data.scamAlert ? 1 : -1; // Non-scam first
  }
  if (a.data.blacklisted !== b.data.blacklisted) {
    return a.data.blacklisted ? 1 : -1; // Non-blacklisted first
  }
  return b.data.trustScore - a.data.trustScore; // Higher trust score first
});

// Separate brokers by status
const trustedBrokers = brokers.filter(b => !b.data.scamAlert && !b.data.blacklisted && b.data.trustScore >= 70);
const regularBrokers = brokers.filter(b => !b.data.scamAlert && !b.data.blacklisted && b.data.trustScore < 70);
const riskBrokers = brokers.filter(b => b.data.scamAlert || b.data.blacklisted);

// Get unique countries and regulations
const countries = [...new Set(brokers.map(b => b.data.countryOrigin))].sort();
const regulations = [...new Set(brokers.flatMap(b => b.data.regulations.map(r => r.entity)))].sort();

function getRiskBadge(broker: any) {
  if (broker.data.scamAlert || broker.data.blacklisted) {
    return { text: 'Alto Riesgo', class: 'bg-red-100 text-red-800 border-red-200' };
  }
  
  switch (broker.data.riskLevel) {
    case 'low':
      return { text: 'Bajo Riesgo', class: 'bg-green-100 text-green-800 border-green-200' };
    case 'medium':
      return { text: 'Riesgo Medio', class: 'bg-yellow-100 text-yellow-800 border-yellow-200' };
    case 'high':
      return { text: 'Alto Riesgo', class: 'bg-orange-100 text-orange-800 border-orange-200' };
    case 'extreme':
      return { text: 'Riesgo Extremo', class: 'bg-red-100 text-red-800 border-red-200' };
    default:
      return { text: 'Sin Evaluar', class: 'bg-gray-100 text-gray-800 border-gray-200' };
  }
}
---

<BaseLayout 
  title="Brokers - Análisis y Reviews Independientes"
  description="Análisis completos de brokers de forex, CFDs y criptomonedas. Reviews honestas, ratings y advertencias para ayudarte a elegir el mejor broker."
>
  <Header />
  
  <main id="main-content">
    <!-- Header Section -->
    <section class="bg-gray-50 py-12">
      <div class="container">
        <div class="max-w-4xl mx-auto text-center">
          <h1 class="text-4xl md:text-5xl font-bold text-gray-900 mb-4">
            Análisis de Brokers
          </h1>
          <p class="text-xl text-gray-600 mb-8">
            Reviews independientes y honestas de los principales brokers del mercado. 
            Encuentra el broker que mejor se adapte a tu perfil de trading.
          </p>
          
          <!-- Quick Stats -->
          <div class="grid grid-cols-2 md:grid-cols-4 gap-6 mt-8">
            <div class="bg-white p-4 rounded-lg border">
              <div class="text-2xl font-bold text-blue-600">{brokers.length}</div>
              <div class="text-sm text-gray-600">Brokers Analizados</div>
            </div>
            <div class="bg-white p-4 rounded-lg border">
              <div class="text-2xl font-bold text-green-600">{trustedBrokers.length}</div>
              <div class="text-sm text-gray-600">Recomendados</div>
            </div>
            <div class="bg-white p-4 rounded-lg border">
              <div class="text-2xl font-bold text-red-600">{riskBrokers.length}</div>
              <div class="text-sm text-gray-600">Alto Riesgo</div>
            </div>
            <div class="bg-white p-4 rounded-lg border">
              <div class="text-2xl font-bold text-gray-600">{countries.length}</div>
              <div class="text-sm text-gray-600">Países</div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <div class="container py-12">
      <div class="grid lg:grid-cols-4 gap-8">
        <!-- Filters Sidebar -->
        <aside class="lg:col-span-1">
          <div class="bg-white border border-gray-200 rounded-lg p-6 sticky top-24">
            <h3 class="text-lg font-bold text-gray-900 mb-4">Filtros</h3>
            
            <!-- Regulation Filter -->
            <div class="mb-6">
              <h4 class="font-medium text-gray-900 mb-2">Regulación</h4>
              <div class="space-y-2">
                <label class="flex items-center">
                  <input type="checkbox" class="rounded text-blue-600" />
                  <span class="ml-2 text-sm text-gray-600">Solo regulados</span>
                </label>
              </div>
            </div>

            <!-- Country Filter -->
            <div class="mb-6">
              <h4 class="font-medium text-gray-900 mb-2">País de Origen</h4>
              <select class="w-full border border-gray-300 rounded px-3 py-2 text-sm">
                <option value="">Todos los países</option>
                {countries.map(country => (
                  <option value={country}>{country}</option>
                ))}
              </select>
            </div>

            <!-- Min Deposit Filter -->
            <div class="mb-6">
              <h4 class="font-medium text-gray-900 mb-2">Depósito Mínimo</h4>
              <select class="w-full border border-gray-300 rounded px-3 py-2 text-sm">
                <option value="">Cualquier cantidad</option>
                <option value="0">Sin depósito mínimo</option>
                <option value="100">Hasta $100</option>
                <option value="500">Hasta $500</option>
                <option value="1000">Hasta $1,000</option>
              </select>
            </div>

            <!-- Instruments Filter -->
            <div class="mb-6">
              <h4 class="font-medium text-gray-900 mb-2">Instrumentos</h4>
              <div class="space-y-2 text-sm">
                <label class="flex items-center">
                  <input type="checkbox" class="rounded text-blue-600" />
                  <span class="ml-2 text-gray-600">Forex</span>
                </label>
                <label class="flex items-center">
                  <input type="checkbox" class="rounded text-blue-600" />
                  <span class="ml-2 text-gray-600">CFDs</span>
                </label>
                <label class="flex items-center">
                  <input type="checkbox" class="rounded text-blue-600" />
                  <span class="ml-2 text-gray-600">Criptomonedas</span>
                </label>
                <label class="flex items-center">
                  <input type="checkbox" class="rounded text-blue-600" />
                  <span class="ml-2 text-gray-600">Acciones</span>
                </label>
              </div>
            </div>

            <button class="w-full bg-blue-600 text-white py-2 rounded font-medium hover:bg-blue-700 transition-colors">
              Aplicar Filtros
            </button>
          </div>
        </aside>

        <!-- Main Content -->
        <div class="lg:col-span-3">
          <!-- Trusted Brokers -->
          {trustedBrokers.length > 0 && (
            <section class="mb-12">
              <div class="flex items-center gap-3 mb-6">
                <div class="w-3 h-3 bg-green-500 rounded-full"></div>
                <h2 class="text-2xl font-bold text-gray-900">
                  Brokers Recomendados ({trustedBrokers.length})
                </h2>
              </div>
              
              <div class="grid gap-6">
                {trustedBrokers.map(broker => {
                  const riskBadge = getRiskBadge(broker);
                  return (
                    <div class="bg-white border-2 border-green-200 rounded-lg p-6 hover:shadow-lg transition-shadow">
                      <div class="flex flex-col md:flex-row gap-6">
                        <!-- Broker Info -->
                        <div class="md:w-1/3">
                          <div class="flex items-center gap-4 mb-4">
                            <img 
                              src={broker.data.logo.src} 
                              alt={`Logo de ${broker.data.name}`}
                              class="w-16 h-16 object-contain bg-gray-50 rounded p-2"
                            />
                            <div>
                              <h3 class="text-xl font-bold text-gray-900">
                                <a href={`/brokers/${broker.slug}`} class="hover:text-blue-600">
                                  {broker.data.name}
                                </a>
                              </h3>
                              <p class="text-gray-600 text-sm">{broker.data.countryOrigin}</p>
                              <p class="text-xs text-gray-500">Fundado en {broker.data.foundedYear}</p>
                            </div>
                          </div>
                          
                          <div class="flex gap-2 mb-4">
                            <span class={`px-2 py-1 text-xs font-medium rounded border ${riskBadge.class}`}>
                              {riskBadge.text}
                            </span>
                            {broker.data.isRegulated && (
                              <span class="bg-blue-100 text-blue-800 px-2 py-1 text-xs font-medium rounded border border-blue-200">
                                Regulado
                              </span>
                            )}
                          </div>
                        </div>

                        <!-- Details -->
                        <div class="md:w-1/3">
                          <div class="space-y-2 text-sm">
                            <div class="flex justify-between">
                              <span class="text-gray-600">Puntuación:</span>
                              <div class="flex items-center gap-1">
                                <span class="font-medium">{broker.data.rating}/5</span>
                                <div class="flex">
                                  {Array.from({length: 5}, (_, i) => (
                                    <svg 
                                      class={`w-3 h-3 ${i < Math.floor(broker.data.rating) ? 'text-yellow-400' : 'text-gray-300'}`}
                                      fill="currentColor" 
                                      viewBox="0 0 20 20"
                                    >
                                      <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
                                    </svg>
                                  ))}
                                </div>
                              </div>
                            </div>
                            <div class="flex justify-between">
                              <span class="text-gray-600">Confianza:</span>
                              <span class="font-medium">{broker.data.trustScore}%</span>
                            </div>
                            <div class="flex justify-between">
                              <span class="text-gray-600">Depósito mín:</span>
                              <span class="font-medium">${broker.data.minDeposit}</span>
                            </div>
                            <div class="flex justify-between">
                              <span class="text-gray-600">Apalancamiento:</span>
                              <span class="font-medium">{broker.data.maxLeverage}</span>
                            </div>
                            <div class="flex justify-between">
                              <span class="text-gray-600">Spreads desde:</span>
                              <span class="font-medium">{broker.data.spreadsFrom} pips</span>
                            </div>
                          </div>
                        </div>

                        <!-- Actions -->
                        <div class="md:w-1/3 flex flex-col justify-between">
                          <div class="mb-4">
                            <h4 class="text-sm font-medium text-gray-900 mb-2">Instrumentos:</h4>
                            <div class="flex flex-wrap gap-1">
                              {broker.data.instruments.forex && (
                                <span class="bg-gray-100 text-gray-700 px-2 py-1 text-xs rounded">Forex</span>
                              )}
                              {broker.data.instruments.stocks && (
                                <span class="bg-gray-100 text-gray-700 px-2 py-1 text-xs rounded">Acciones</span>
                              )}
                              {broker.data.instruments.cryptocurrencies && (
                                <span class="bg-gray-100 text-gray-700 px-2 py-1 text-xs rounded">Crypto</span>
                              )}
                              {broker.data.instruments.indices && (
                                <span class="bg-gray-100 text-gray-700 px-2 py-1 text-xs rounded">Índices</span>
                              )}
                            </div>
                          </div>
                          
                          <div class="space-y-2">
                            <a 
                              href={`/brokers/${broker.slug}`}
                              class="block w-full text-center bg-blue-600 text-white py-2 rounded font-medium hover:bg-blue-700 transition-colors"
                            >
                              Ver Análisis Completo
                            </a>
                            {broker.data.affiliateLink && (
                              <a 
                                href={broker.data.affiliateLink}
                                target="_blank"
                                rel="noopener noreferrer"
                                class="block w-full text-center border border-blue-600 text-blue-600 py-2 rounded font-medium hover:bg-blue-50 transition-colors"
                              >
                                Visitar Broker
                              </a>
                            )}
                          </div>
                        </div>
                      </div>
                    </div>
                  );
                })}
              </div>
            </section>
          )}

          <!-- Regular Brokers -->
          {regularBrokers.length > 0 && (
            <section class="mb-12">
              <div class="flex items-center gap-3 mb-6">
                <div class="w-3 h-3 bg-yellow-500 rounded-full"></div>
                <h2 class="text-2xl font-bold text-gray-900">
                  Otros Brokers ({regularBrokers.length})
                </h2>
              </div>
              
              <div class="grid gap-4">
                {regularBrokers.map(broker => {
                  const riskBadge = getRiskBadge(broker);
                  return (
                    <div class="bg-white border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow">
                      <div class="flex flex-col md:flex-row items-center gap-4">
                        <div class="flex items-center gap-3">
                          <img 
                            src={broker.data.logo.src} 
                            alt={`Logo de ${broker.data.name}`}
                            class="w-12 h-12 object-contain bg-gray-50 rounded p-1"
                          />
                          <div>
                            <h3 class="font-bold text-gray-900">
                              <a href={`/brokers/${broker.slug}`} class="hover:text-blue-600">
                                {broker.data.name}
                              </a>
                            </h3>
                            <p class="text-sm text-gray-600">{broker.data.countryOrigin}</p>
                          </div>
                        </div>

                        <div class="flex-1 grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                          <div>
                            <span class="text-gray-600">Rating:</span>
                            <span class="ml-1 font-medium">{broker.data.rating}/5</span>
                          </div>
                          <div>
                            <span class="text-gray-600">Depósito:</span>
                            <span class="ml-1 font-medium">${broker.data.minDeposit}</span>
                          </div>
                          <div>
                            <span class="text-gray-600">Regulado:</span>
                            <span class={`ml-1 font-medium ${broker.data.isRegulated ? 'text-green-600' : 'text-red-600'}`}>
                              {broker.data.isRegulated ? 'Sí' : 'No'}
                            </span>
                          </div>
                          <div>
                            <span class={`px-2 py-1 text-xs font-medium rounded ${riskBadge.class}`}>
                              {riskBadge.text}
                            </span>
                          </div>
                        </div>

                        <div class="flex gap-2">
                          <a 
                            href={`/brokers/${broker.slug}`}
                            class="bg-blue-600 text-white px-4 py-2 rounded text-sm font-medium hover:bg-blue-700 transition-colors"
                          >
                            Ver Análisis
                          </a>
                        </div>
                      </div>
                    </div>
                  );
                })}
              </div>
            </section>
          )}

          <!-- Risk Brokers -->
          {riskBrokers.length > 0 && (
            <section>
              <div class="flex items-center gap-3 mb-6">
                <div class="w-3 h-3 bg-red-500 rounded-full"></div>
                <h2 class="text-2xl font-bold text-gray-900">
                  Brokers de Alto Riesgo ({riskBrokers.length})
                </h2>
              </div>
              
              <div class="bg-red-50 border border-red-200 rounded-lg p-4 mb-6">
                <div class="flex">
                  <div class="flex-shrink-0">
                    <span class="text-red-400 text-lg">⚠️</span>
                  </div>
                  <div class="ml-3">
                    <h3 class="text-sm font-bold text-red-800">Advertencia Importante</h3>
                    <p class="text-sm text-red-700 mt-1">
                      Los brokers listados a continuación presentan alertas de riesgo o han sido identificados 
                      como problemáticos. Se recomienda extrema precaución.
                    </p>
                  </div>
                </div>
              </div>

              <div class="grid gap-4">
                {riskBrokers.map(broker => (
                  <div class="bg-white border-2 border-red-200 rounded-lg p-4">
                    <div class="flex flex-col md:flex-row items-center gap-4">
                      <div class="flex items-center gap-3">
                        <img 
                          src={broker.data.logo.src} 
                          alt={`Logo de ${broker.data.name}`}
                          class="w-12 h-12 object-contain bg-gray-50 rounded p-1 opacity-60"
                        />
                        <div>
                          <h3 class="font-bold text-gray-900">{broker.data.name}</h3>
                          <p class="text-sm text-gray-600">{broker.data.countryOrigin}</p>
                        </div>
                      </div>

                      <div class="flex-1">
                        <div class="flex flex-wrap gap-2">
                          {broker.data.scamAlert && (
                            <span class="bg-red-100 text-red-800 px-2 py-1 text-xs font-bold rounded border border-red-200">
                              ALERTA DE ESTAFA
                            </span>
                          )}
                          {broker.data.blacklisted && (
                            <span class="bg-gray-800 text-white px-2 py-1 text-xs font-bold rounded">
                              LISTA NEGRA
                            </span>
                          )}
                          {broker.data.warnings && broker.data.warnings.length > 0 && (
                            <span class="bg-orange-100 text-orange-800 px-2 py-1 text-xs font-medium rounded border border-orange-200">
                              {broker.data.warnings.length} Advertencia{broker.data.warnings.length > 1 ? 's' : ''}
                            </span>
                          )}
                        </div>
                      </div>

                      <div>
                        <a 
                          href={`/brokers/${broker.slug}`}
                          class="bg-gray-600 text-white px-4 py-2 rounded text-sm font-medium hover:bg-gray-700 transition-colors"
                        >
                          Ver Detalles
                        </a>
                      </div>
                    </div>
                  </div>
                ))}
              </div>
            </section>
          )}
        </div>
      </div>
    </div>
  </main>
  
  <Footer />
</BaseLayout>